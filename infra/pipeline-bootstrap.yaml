AWSTemplateFormatVersion: '2010-09-09'
Description: 'Service Bootstrap Pipeline: Deploy service-level shared infrastructure (Cloud Map Service, LogGroup, ALB)'

Parameters:
  # =========================================================
  # Required Parameters
  # =========================================================
  PipelineName:
    Type: String
    Default: 'service-bootstrap'
    Description: 'Service Bootstrap Pipeline name'


  # =========================================================
  # Optional Parameters
  # =========================================================
  ConnectionArn:
    Type: String
    Default: 'arn:aws:codeconnections:us-east-1:297997107448:connection/9adfd918-2843-4147-9bc9-c4ee1a99bc39'
    Description: 'CodeStar connection ARN (GitHub integration)'

  ArtifactBucketName:
    Type: String
    Default: 'codepipeline-us-east-1-3622cd43956e-4d23-9284-a18746ff6c07'
    Description: 'S3 artifact bucket for CodePipeline artifacts'

  CloudFormationDeployRoleArn:
    Type: String
    Description: 'IAM Role ARN for CloudFormation deployments'

  CodePipelineRoleArn:
    Type: String
    Description: 'IAM Role ARN for CodePipeline'

Resources:
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Ref PipelineName
      RoleArn: !Ref CodePipelineRoleArn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucketName

      Variables:
        - Name: Service
          DefaultValue: ''
          Description: 'ECS service name (e.g. demo-rpc or demo-api)'
        - Name: Env
          DefaultValue: 'dev'
          Description: 'Environment name'

      Stages:
        - Name: Source
          Actions:
            - Name: InfraSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                ConnectionArn: !Ref ConnectionArn
                FullRepositoryId: 'nianien/infra-devops'
                BranchName: 'master'
                OutputArtifactFormat: CODE_ZIP
                DetectChanges: false
              OutputArtifacts:
                - Name: InfraOut

        - Name: DeployServiceDiscovery
          Actions:
            - Name: CFNDeployServiceDiscovery
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: InfraOut
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub 'sd-service-#{variables.Service}-#{variables.Env}'
                TemplatePath: 'InfraOut::ci/sd-stack.yaml'
                RoleArn: !Ref CloudFormationDeployRoleArn
                Capabilities: 'CAPABILITY_IAM,CAPABILITY_NAMED_IAM'
                ParameterOverrides: !Sub |
                  {
                    "ServiceName": "#{variables.Service}",
                    "Env": "#{variables.Env}",
                    "NamespaceStackName": "sd-namespace-shared"
                  }

        - Name: DeployLog
          Actions:
            - Name: CFNDeployLog
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: InfraOut
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub 'log-#{variables.Service}-#{variables.Env}'
                TemplatePath: 'InfraOut::ci/log-stack.yaml'
                RoleArn: !Ref CloudFormationDeployRoleArn
                Capabilities: 'CAPABILITY_IAM,CAPABILITY_NAMED_IAM'
                ParameterOverrides: !Sub |
                  {
                    "ServiceName": "#{variables.Service}",
                    "Env": "#{variables.Env}"
                  }

        - Name: DeployAlb
          Actions:
            - Name: CFNDeployAlb
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: InfraOut
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub 'alb-#{variables.Service}-#{variables.Env}'
                TemplatePath: 'InfraOut::ci/alb-stack.yaml'
                RoleArn: !Ref CloudFormationDeployRoleArn
                Capabilities: 'CAPABILITY_IAM,CAPABILITY_NAMED_IAM'
                ParameterOverrides: !Sub |
                  {
                    "ServiceName": "#{variables.Service}",
                    "Env": "#{variables.Env}"
                  }

      RestartExecutionOnUpdate: true

Outputs:
  PipelineNameOut:
    Value: !Ref PipelineName
    Description: 'Service Bootstrap Pipeline Name'
  
  ServiceDiscoveryStackName:
    Value: !Sub 'sd-service-#{variables.Service}-#{variables.Env}'
    Description: 'Cloud Map Service Stack Name'
    Export:
      Name: !Sub '${AWS::StackName}-ServiceDiscoveryStack'
  
  LogGroupStackName:
    Value: !Sub 'log-#{variables.Service}-#{variables.Env}'
    Description: 'LogGroup Stack Name'
    Export:
      Name: !Sub '${AWS::StackName}-LogGroupStack'
  
  AlbStackName:
    Value: !Sub 'alb-#{variables.Service}-#{variables.Env}'
    Description: 'ALB Stack Name'
    Export:
      Name: !Sub '${AWS::StackName}-AlbStack'
